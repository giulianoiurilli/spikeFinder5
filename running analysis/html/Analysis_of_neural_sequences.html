
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>Analysis of neural sequences within and across sniffs</title><meta name="generator" content="MATLAB 8.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2015-10-01"><meta name="DC.source" content="Analysis_of_neural_sequences.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>Analysis of neural sequences within and across sniffs</h1><!--introduction--><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Let's give a look at the responses.</a></li><li><a href="#8">Coherence and cross-correlation between neurons</a></li></ul></div><h2>Let's give a look at the responses.<a name="1"></a></h2><p>Let's start from the experiment 08-17-15/d3800 in anterior piriform cortex.</p><p><img vspace="5" hspace="5" src="/Users/Giuliano/Documents/MATLAB/spikeFinder5/running analysis/html/08-17-15_d3800_apcx.png" alt=""> </p><p><b>All right, unit 5 on shank 1. Odor: TMT 1:10000</b></p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_01.png" style="width:1135px;height:109px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_02.png" style="width:1135px;height:109px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_03.png" style="width:560px;height:420px;" alt=""> <p><b>Same unit. Odor: isobutylacetate 1:10000</b></p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_04.png" style="width:1135px;height:109px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_05.png" style="width:1135px;height:109px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_06.png" style="width:560px;height:420px;" alt=""> <p>Let's switch unit. <b>Shank 3, unit 3. Odor: 5-methylthiazol 1:10000</b></p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_07.png" style="width:1135px;height:109px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_08.png" style="width:1135px;height:109px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_09.png" style="width:560px;height:420px;" alt=""> <p><b>Shank 3, unit 3. Odor: 5-methylthiazol 1:10000</b></p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_10.png" style="width:1135px;height:109px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_11.png" style="width:1135px;height:109px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_12.png" style="width:560px;height:420px;" alt=""> <p>It's clear that breath-warping makes the onset of the first breath response sharper and unveils responses during the following sniffs. However, the spikes get diluted when the mouse sniffs (usually at the first trial). Sniffing increases the spike density in time coordinates. For PSTHs (smoothed with a gaussian window of 10 deg) I use phase coordinates on the x axis, but Hz on the y axis. I normalize by the duration of each specific inhalation and exhalation. But again, this actually fixes the problem within a sniff, but not across sniffs. <i>There is an important thing to consider here. Let's imagine there is a mouse that breaths at 2 Hz and one of its neurons emits a spike at each breath. Then, we present an odor and the mouse starts sniffing at 10 Hz. This would result in a response even if the synaptic input hasn't changed.</i> <b>Weird!</b> <i>Well, if this neurons is actually modulated by the olfactory input as well, then the mouse must know how fast he's breathing to disambiguate it.</i> On the other hand, I think that the circuit operates on a timescale of tens of milliseconds rather than hundreds, therefore the higher precision provided by the breath-warping procedure may be more appropriate. <b>Let's give a look at these breath-clock neurons. Here, there are two from shank 1 and shank 4.</b></p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_13.png" style="width:900px;height:800px;" alt=""> <p>Clearly, these two neurons encode breathing <b>and</b> odor identity/concentration</p><h2>Coherence and cross-correlation between neurons<a name="8"></a></h2><p>Let's look at sequential activations of pairs of units by odors. We can use a cross-correlogram. Since, the previous comparison between the responses of two units showed that each unit respond to a given odor at a preffered breath cycle, I will clculate the cross-correlations in the first 4 cycles. Bin width: 5 deg.</p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_14.png" style="width:1382px;height:754px;" alt=""> <p>So, these two units are quite in phase when they are not excited by an odor. Perhaps, unit 1 slightly precedes unit 2. However, everytime that a unit responds, its spikes</p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_15.png" style="width:1382px;height:754px;" alt=""> <p>Let's see what happen between the second unit from the previous plot and a different unit on shank3 (unit 3).</p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_16.png" style="width:900px;height:800px;" alt=""> <p>And cross-correlations for each breath cycle</p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_17.png" style="width:1382px;height:754px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_18.png" style="width:1382px;height:754px;" alt=""> <p>Let's see what happen between the first unit from the first plot and unit 3 on shank3.</p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_19.png" style="width:900px;height:800px;" alt=""> <p>And cross-correlations for each breath cycle</p><img vspace="5" hspace="5" src="Analysis_of_neural_sequences_20.png" style="width:1382px;height:754px;" alt=""> <img vspace="5" hspace="5" src="Analysis_of_neural_sequences_21.png" style="width:1382px;height:754px;" alt=""> <p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015b</a><br></p></div><!--
##### SOURCE BEGIN #####
%% Analysis of neural sequences within and across sniffs

%% Let's give a look at the responses. 
% Let's start from the experiment 08-17-15/d3800 in anterior piriform
% cortex.
% 
% <</Users/Giuliano/Documents/MATLAB/spikeFinder5/running analysis/html/08-17-15_d3800_apcx.png>>
% 
idxExp = 1;
% I will pick only well-isolated units.

shank_unitPairs = [1,4;...
                   1,5;...
                   3,1;...
                   3,2;...
                   3,3;...
                   3,5;...
                   4,1;...
                   4,3;...
                   4,4;...
                   4,5];

odorsRearranged = [1, 8, 2, 9, 3, 10, 4, 11, 5, 12, 6, 13, 7, 14, 15];
psthTicks = [0:cycleLengthDeg:6*cycleLengthDeg]; 


%% 
% *All right, unit 5 on shank 1. Odor: TMT 1:10000*
idxShank = shank_unitPairs(2,1);
idxUnit = shank_unitPairs(2,2);

for idxOdor = 1%odorsRearranged
    spikesMatMs = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).spikeMatrixNoWarp;
    spikesPSTHsMs = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).sdf_trialNoWarp;
    spikesMatRad = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).spikeMatrix;
    spikesPSTHsRad = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).smoothedPsth;
end

figure; 
set(gcf,'Position',[68 689 1135 109]);
subplot(1,2,1)
imagesc(spikesMatMs(:,14800:15200)); colormap('bone');freezeColors
ymax = get(gca, 'YLim');
hold on
plot([200 200], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
hold off
title('First sniff onset alignement');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
subplot(1,2,2)
imagesc(spikesPSTHsMs(:,14500:16000)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([500 500], ymax, 'g', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
hold off
set(gcf,'Color','w')

figure; 
subplot(1,2,1)
imagesc(spikesMatRad(:,3*cycleLengthDeg+1:5*cycleLengthDeg)); colormap('bone');freezeColors
ymax = get(gca, 'YLim');
hold on
plot([cycleLengthDeg cycleLengthDeg+1], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('deg');
hold off
set(gcf,'Position',[68 689 1135 109]);
set(gca, 'XTick' , psthTicks);
title('First sniff onset alignement and sniff warping - 1 sniff pre odor and 4 sniffs post odor');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
subplot(1,2,2)
imagesc(spikesPSTHsRad(:,2*cycleLengthDeg+1:8*cycleLengthDeg)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([2*cycleLengthDeg 2*cycleLengthDeg+1], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('deg');
set(gca, 'XTick' , psthTicks);
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
hold off
set(gcf,'Color','w')

figure; sniff = squeeze(breath(1:5,20*(14550:16000),1));
xtime = -450:1000;
hold on
for i = 1:5
    plot(xtime, sniff(i,:) - (i-1)*1.2, 'k', 'linewidth', 2); axis tight
end
xlabel('ms');
ymax = get(gca, 'YLim');
plot([0 0], ymax, 'r', 'linewidth', 2);
hold off
title('Sniffs');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
set(gca,'YTick',[])
set(gcf,'Color','w')

%% 
% *Same unit. Odor: isobutylacetate 1:10000*
idxShank = shank_unitPairs(2,1);
idxUnit = shank_unitPairs(2,2);

for idxOdor = 11%odorsRearranged
    spikesMatMs = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).spikeMatrixNoWarp;
    spikesPSTHsMs = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).sdf_trialNoWarp;
    spikesMatRad = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).spikeMatrix;
    spikesPSTHsRad = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).smoothedPsth;
end

figure; 
subplot(1,2,1)
imagesc(spikesMatMs(:,14800:15200)); colormap('bone');freezeColors
ymax = get(gca, 'YLim');
hold on
plot([200 200], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
hold off
set(gcf,'Position',[68 689 1135 109]);
title('First sniff onset alignement');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
subplot(1,2,2)
imagesc(spikesPSTHsMs(:,14500:16000)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([500 500], ymax, 'g', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
hold off
set(gcf,'Color','w')

figure; 
subplot(1,2,1)
imagesc(spikesMatRad(:,3*cycleLengthDeg+1:5*cycleLengthDeg)); colormap('bone');freezeColors
ymax = get(gca, 'YLim');
hold on
plot([cycleLengthDeg cycleLengthDeg+1], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('deg');
hold off
set(gcf,'Position',[68 689 1135 109]);
set(gca, 'XTick' , psthTicks);
title('First sniff onset alignement and sniff warping');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
subplot(1,2,2)
imagesc(spikesPSTHsRad(:,2*cycleLengthDeg+1:8*cycleLengthDeg)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([2*cycleLengthDeg 2*cycleLengthDeg+1], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('deg');
set(gca, 'XTick' , psthTicks);
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
hold off
set(gcf,'Color','w')


figure; sniff = squeeze(breath(1:5,20*(14550:16000),11));
xtime = -450:1000;
hold on
for i = 1:5
    plot(xtime, sniff(i,:) - (i-1)*1.2, 'k', 'linewidth', 2); axis tight
end
xlabel('ms');
ymax = get(gca, 'YLim');
plot([0 0], ymax, 'r', 'linewidth', 2);
hold off
title('Sniffs');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
set(gca,'YTick',[])
set(gcf,'Color','w')


%% 
% Let's switch unit. *Shank 3, unit 3. Odor: 5-methylthiazol 1:10000*

idxShank = shank_unitPairs(5,1);
idxUnit = shank_unitPairs(5,2);

for idxOdor = 3%odorsRearranged
    spikesMatMs = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).spikeMatrixNoWarp;
    spikesPSTHsMs = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).sdf_trialNoWarp;
    spikesMatRad = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).spikeMatrix;
    spikesPSTHsRad = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).smoothedPsth;
end

figure; 
subplot(1,2,1)
imagesc(spikesMatMs(:,14800:15200)); colormap('bone');freezeColors
ymax = get(gca, 'YLim');
hold on
plot([200 200], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
hold off
set(gcf,'Position',[68 689 1135 109]);
title('First sniff onset alignement');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
subplot(1,2,2)
imagesc(spikesPSTHsMs(:,14550:16000)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([500 500], ymax, 'g', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
hold off
subplot(1,2,2)
imagesc(spikesPSTHsMs(:,14500:16000)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([500 500], ymax, 'g', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
hold off
set(gcf,'Color','w')

figure; 
subplot(1,2,1)
imagesc(spikesMatRad(:,3*cycleLengthDeg+1:5*cycleLengthDeg)); colormap('bone');freezeColors
ymax = get(gca, 'YLim');
hold on
plot([cycleLengthDeg cycleLengthDeg+1], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('deg');
hold off
set(gcf,'Position',[68 689 1135 109]);
title('First sniff onset alignement and sniff warping');
set(gca, 'XTick' , psthTicks);
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
subplot(1,2,2)
imagesc(spikesPSTHsRad(:,2*cycleLengthDeg+1:8*cycleLengthDeg)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([2*cycleLengthDeg 2*cycleLengthDeg+1], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('deg');
set(gca, 'XTick' , psthTicks);
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
hold off
set(gcf,'Color','w')

figure; sniff = squeeze(breath(1:5,20*(14550:16000),3));
xtime = -450:1000;
hold on
for i = 1:5
    plot(xtime, sniff(i,:) - (i-1)*1.2, 'k', 'linewidth', 2); axis tight
end
xlabel('ms');
ymax = get(gca, 'YLim');
plot([0 0], ymax, 'r', 'linewidth', 2);
hold off
title('Sniffs');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
set(gca,'YTick',[])
set(gcf,'Color','w')

%% 
% *Shank 3, unit 3. Odor: 5-methylthiazol 1:10000*

idxShank = shank_unitPairs(5,1);
idxUnit = shank_unitPairs(5,2);

for idxOdor = odorsRearranged(12)%odorsRearranged
    spikesMatMs = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).spikeMatrixNoWarp;
    spikesPSTHsMs = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).sdf_trialNoWarp;
    spikesMatRad = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).spikeMatrix;
    spikesPSTHsRad = exp(idxExp).shank(idxShank).cell(idxUnit).odor(idxOdor).smoothedPsth;
end

figure; 
subplot(1,2,1)
imagesc(spikesMatMs(:,14800:15200)); colormap('bone');freezeColors
ymax = get(gca, 'YLim');
hold on
plot([200 200], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
hold off
set(gcf,'Position',[68 689 1135 109]);
title('First sniff onset alignement');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
subplot(1,2,2)
imagesc(spikesPSTHsMs(:,14500:16000)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([500 500], ymax, 'g', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
hold off
subplot(1,2,2)
imagesc(spikesPSTHsMs(:,14550:16000)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([500 500], ymax, 'g', 'linewidth', 2);
ylabel('trial#'); xlabel('ms');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
hold off
set(gcf,'Color','w')

figure; 
subplot(1,2,1)
imagesc(spikesMatRad(:,3*cycleLengthDeg+1:5*cycleLengthDeg)); colormap('bone');freezeColors
ymax = get(gca, 'YLim');
hold on
plot([cycleLengthDeg cycleLengthDeg+1], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('deg');
hold off
set(gcf,'Position',[68 689 1135 109]);
title('First sniff onset alignement and sniff warping');
set(gca, 'XTick' , psthTicks);
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
subplot(1,2,2)
imagesc(spikesPSTHsRad(:,2*cycleLengthDeg+1:8*cycleLengthDeg)); colormap(brewermap([],'*RdBu'))
ymax = get(gca, 'YLim');
hold on
plot([2*cycleLengthDeg 2*cycleLengthDeg+1], ymax, 'r', 'linewidth', 2);
ylabel('trial#'); xlabel('deg');
set(gca, 'XTick' , psthTicks);
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
hold off
set(gcf,'Color','w')

figure; sniff = squeeze(breath(1:5,20*(14550:16000),odorsRearranged(12)));
xtime = -450:1000;
hold on
for i = 1:5
    plot(xtime, sniff(i,:) - (i-1)*1.2, 'k', 'linewidth', 2); axis tight
end
xlabel('ms');
ymax = get(gca, 'YLim');
plot([0 0], ymax, 'r', 'linewidth', 2);
hold off
title('Sniffs');
set(gca,'FontName','Arial','Fontsize',14,'FontWeight','normal','TickDir','out','Box','off');
set(gca,'YTick',[])
set(gcf,'Color','w')

%%
% It's clear that breath-warping makes the onset of the first breath response
% sharper and unveils responses during the following sniffs. However, the
% spikes get diluted when the mouse sniffs (usually at the first trial).
% Sniffing increases the spike density in time coordinates. 
% For PSTHs (smoothed with a gaussian window of 10 deg)
% I use phase coordinates on the x axis, but Hz on the y axis. I normalize
% by the duration of each specific inhalation and exhalation. But again,
% this actually fixes the problem within a sniff, but not across sniffs.
% _There is an important thing to consider here. Let's imagine there is a 
% mouse that breaths at 2 Hz and one of its neurons emits a spike at each breath.
% Then, we present an odor and the mouse starts sniffing at 10 Hz. 
% This would result in a response even if the synaptic
% input hasn't changed._ *Weird!* _Well, if this neurons is actually
% modulated by the olfactory input as well, then the mouse must know how
% fast he's breathing to disambiguate it._
% On the other hand, I think that the circuit operates on a timescale
% of tens of milliseconds rather than hundreds, therefore the higher precision 
% provided by the breath-warping procedure may be more appropriate. 
% *Let's give a look at these breath-clock neurons. Here, there are two from
% shank 1 and shank 4.*

idxShank1 = 1;
idxUnit1 = 5;
idxShank2 = 4;
idxUnit2 = 3;

bslWindow = preInhalations * cycleLengthDeg;
odorWindow = 0:postInhalations;
rasterTicks = [-preInhalations :0.5: postInhalations] * 2 * pi; rasterTicks(end) = [];
psthTicks = [0.5 : 2 * (preInhalations + postInhalations) + 0.5]; psthTicks(end) = [];
sdfTicks = [0 : 180 : (preInhalations + postInhalations) * cycleLengthDeg]; %sdfTicks(end) = [];
ciclo = {'i', 'e'}; labels = repmat(ciclo, 1, preInhalations); labels{2 * preInhalations + 1} = '0'; labels{2 * preInhalations + 2} = 'e';
labelsPost = repmat(ciclo, 1, postInhalations - 1); labels = [labels labelsPost];
radTick = [1 cycleLengthDeg];
radLabels={'0','2\pi'};
useColorOnset = 'ForestGreen';

odor_list = {'tmt3', 'dmt3', 'mmt3', 'iba3', 'iaa3',...
             'hed3', 'but3', 'tmt1', 'dmt1', 'mmt1',...
             'iba1', 'iaa1', 'hed1', 'btd1', 'rose'};


listOdors = {'TMT^-4', 'TMT^-2', 'DMT^-4', 'DMT^-2', 'MT^-4', 'MT^-2',...
             'IBA^-4', 'IBA^-2', 'IAA^-4', 'IAA^-2', 'HXD^-4', 'HXD^-2', 'BTD^-4', 'BTD^-2', 'rose'};
odorsRearranged = [1, 8, 2, 9, 3, 10, 4, 11, 5, 12, 6, 13, 7, 14, 15];

binSizes = 5:5:cycleLengthDeg;
timePoints = 5:5:cycleLengthDeg;

titolo1 = sprintf('shank %d, unit %d', idxShank1, idxUnit1);
titolo2 = sprintf('shank %d, unit %d', idxShank2, idxUnit2);



Xfig = 900;
Yfig = 800;
figure;
p = panel();
set(gcf, 'Position',[1,5,Xfig,Yfig]);

p.pack('h',{50 50});

p(1).pack('v', {1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15});
p(2).pack('v', {1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15});


%Find max peak for sdf plot
maxPeak = 0.1;
for idxOdor = odorsRearranged
    maxPeakOdor = max(shank(idxShank2).cell(idxUnit2).odor(idxOdor).cyclePeakResponseAnalogicHz);
    if maxPeakOdor >= maxPeak
        maxPeak = maxPeakOdor;
    end
end
    

% Raster plots
idxPlot = 1;
for idxOdor = odorsRearranged
    if idxPlot == 15
        p(1,idxPlot).select();
        plotSpikeRaster(shank(idxShank1).cell(idxUnit1).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        ylabel(listOdors(idxPlot))
        set(gca, 'XTick' , rasterTicks);
        set(gca, 'XTickLabel', labels);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    else
        p(1,idxPlot).select();
        plotSpikeRaster(shank(idxShank1).cell(idxUnit1).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        set(gca, 'XTick' , []);
        set(gca, 'XTickLabel', []);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        ylabel(listOdors(idxPlot))
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    end
    idxPlot = idxPlot+1;
end

p(1).title(titolo1);

idxPlot = 1;
for idxOdor = odorsRearranged
    if idxPlot == 15
        p(2,idxPlot).select();
        plotSpikeRaster(shank(idxShank2).cell(idxUnit2).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        ylabel(listOdors(idxPlot))
        set(gca, 'XTick' , rasterTicks);
        set(gca, 'XTickLabel', labels);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    else
        p(2,idxPlot).select();
        plotSpikeRaster(shank(idxShank2).cell(idxUnit2).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        set(gca, 'XTick' , []);
        set(gca, 'XTickLabel', []);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        ylabel(listOdors(idxPlot))
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    end
    idxPlot = idxPlot+1;
end

p(2).title(titolo2);



%p.de.margin = 1;
p.margin = [8 6 4 6];
%p(1).marginright = 10;
p(2).marginleft = 30;
%p(3).marginleft = 10;
p.select('all');


set(gcf,'color','white', 'PaperPositionMode', 'auto');

%%
% Clearly, these two neurons encode breathing *and* odor
% identity/concentration

%% Coherence and cross-correlation between neurons

%% 
% Let's look at sequential activations of pairs of units by odors. We can
% use a cross-correlogram. Since, the previous comparison between the
% responses of two units showed that each unit respond to a given odor at a
% preffered breath cycle, I will clculate the cross-correlations in the
% first 4 cycles. Bin width: 5 deg.


idxShank1 = 1;
idxUnit1 = 5;
idxShank2 = 4;
idxUnit2 = 3;


figure;
set(gcf,'Position',[27 48 1382 754]);
set(gcf,'Color','w')

idxPlot = 1;
for idxOdor = odorsRearranged
    for idxCycle =1:4
        st1_app = shank(idxShank1).cell(idxUnit1).odor(idxOdor).alphaTrial;
        st2_app = shank(idxShank2).cell(idxUnit2).odor(idxOdor).alphaTrial;
        st1Bsl = [];
        st1Rsp = [];
        st2Bsl = [];
        st2Rsp = [];
        bslCC = [];
        rspCC = [];
        for idxTrial = 1:n_trials  
            app = [];
            app = st1_app{idxTrial};
            st1Rsp = app(app > (idxCycle-1) * 2 * pi & app < idxCycle * 2 * pi);       
            app = [];
            app = st2_app{idxTrial};
            st2Rsp = app(app > (idxCycle-1) * 2 * pi & app < idxCycle * 2 * pi);
            M1=[]; M2=[]; D=[];
            M1 = length(st1Rsp);
            M2 = length(st2Rsp);
            D = ones(M2,1)*st1Rsp - st2Rsp'*ones(1,M1);
            D = D(:);
            D = radtodeg(D);
            edges = [];
            Nrsp = [];
            [Nrsp edges] = histcounts(D,-360:5:360);
            rspCC(idxTrial,:) = Nrsp;     
        end
        rspCC = mean(rspCC);
        edges(end) = [];  
        h = subplot(15,4,idxPlot);
        area(edges, rspCC); axis tight
        set(h,'FontName','Arial','Fontsize',8,'FontWeight','normal','TickDir','out','Box','off');
        idxPlot = idxPlot + 1;
        drawnow
    end
end
%%
% So, these two units are quite in phase when they are not excited by an
% odor. Perhaps, unit 1 slightly precedes unit 2. However, everytime that a unit responds, its spikes
%tend to precede those of the other unit. See also figure below where I'm plotting the differential response relative to
%the baseline for unit 1 (blue) and unit 2 (red).

idxShank1 = 1;
idxUnit1 = 5;
idxShank2 = 4;
idxUnit2 = 3;
figure;
set(gcf,'Position',[27 48 1382 754]);
set(gcf,'Color','w')
idxPlot = 1;
for idxOdor = odorsRearranged
    for idxCycle =1:4
        st1_app = [];
        st2_app = [];
        st1_bsl = [];
        st1_bsl= [];
        st1_app= mean(shank(idxShank1).cell(idxUnit1).odor(idxOdor).sdf_trialHz(:,(idxCycle+3) * cycleLengthDeg + 1 : (idxCycle+4) * cycleLengthDeg));
        st2_app = mean(shank(idxShank2).cell(idxUnit2).odor(idxOdor).sdf_trialHz(:,(idxCycle+3) * cycleLengthDeg + 1: (idxCycle+4) * cycleLengthDeg));
        st1_bsl = mean(shank(idxShank1).cell(idxUnit1).cycleBslMultipleSdfHz);
        st2_bsl = mean(shank(idxShank2).cell(idxUnit2).cycleBslMultipleSdfHz);
        st1_app = st1_app - st1_bsl;
        st2_app = st2_app - st2_bsl;
        subplot(15,4,idxPlot)
        plot(st1_app, 'linewidth', 2); hold on; plot(st2_app, 'linewidth', 2); hold off; axis tight; 
        set(gca,'FontName','Arial','Fontsize',8,'FontWeight','normal','TickDir','out','Box','off');
        idxPlot = idxPlot + 1;
    end
end
        
        

%%
% Let's see what happen between the second unit from the previous plot and
% a different unit on shank3 (unit 3).
idxShank1 = 3;
idxUnit1 = 3;
idxShank2 = 4;
idxUnit2 = 3;

bslWindow = preInhalations * cycleLengthDeg;
odorWindow = 0:postInhalations;
rasterTicks = [-preInhalations :0.5: postInhalations] * 2 * pi; rasterTicks(end) = [];
psthTicks = [0.5 : 2 * (preInhalations + postInhalations) + 0.5]; psthTicks(end) = [];
sdfTicks = [0 : 180 : (preInhalations + postInhalations) * cycleLengthDeg]; %sdfTicks(end) = [];
ciclo = {'i', 'e'}; labels = repmat(ciclo, 1, preInhalations); labels{2 * preInhalations + 1} = '0'; labels{2 * preInhalations + 2} = 'e';
labelsPost = repmat(ciclo, 1, postInhalations - 1); labels = [labels labelsPost];
radTick = [1 cycleLengthDeg];
radLabels={'0','2\pi'};
useColorOnset = 'ForestGreen';

odor_list = {'tmt3', 'dmt3', 'mmt3', 'iba3', 'iaa3',...
             'hed3', 'but3', 'tmt1', 'dmt1', 'mmt1',...
             'iba1', 'iaa1', 'hed1', 'btd1', 'rose'};


listOdors = {'TMT^-4', 'TMT^-2', 'DMT^-4', 'DMT^-2', 'MT^-4', 'MT^-2',...
             'IBA^-4', 'IBA^-2', 'IAA^-4', 'IAA^-2', 'HXD^-4', 'HXD^-2', 'BTD^-4', 'BTD^-2', 'rose'};
odorsRearranged = [1, 8, 2, 9, 3, 10, 4, 11, 5, 12, 6, 13, 7, 14, 15];

binSizes = 5:5:cycleLengthDeg;
timePoints = 5:5:cycleLengthDeg;

titolo1 = sprintf('shank %d, unit %d', idxShank1, idxUnit1);
titolo2 = sprintf('shank %d, unit %d', idxShank2, idxUnit2);



Xfig = 900;
Yfig = 800;
figure;
p = panel();
set(gcf, 'Position',[1,5,Xfig,Yfig]);

p.pack('h',{50 50});

p(1).pack('v', {1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15});
p(2).pack('v', {1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15});


%Find max peak for sdf plot
maxPeak = 0.1;
for idxOdor = odorsRearranged
    maxPeakOdor = max(shank(idxShank2).cell(idxUnit2).odor(idxOdor).cyclePeakResponseAnalogicHz);
    if maxPeakOdor >= maxPeak
        maxPeak = maxPeakOdor;
    end
end
    

% Raster plots
idxPlot = 1;
for idxOdor = odorsRearranged
    if idxPlot == 15
        p(1,idxPlot).select();
        plotSpikeRaster(shank(idxShank1).cell(idxUnit1).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        ylabel(listOdors(idxPlot))
        set(gca, 'XTick' , rasterTicks);
        set(gca, 'XTickLabel', labels);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    else
        p(1,idxPlot).select();
        plotSpikeRaster(shank(idxShank1).cell(idxUnit1).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        set(gca, 'XTick' , []);
        set(gca, 'XTickLabel', []);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        ylabel(listOdors(idxPlot))
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    end
    idxPlot = idxPlot+1;
end

p(1).title(titolo1);

idxPlot = 1;
for idxOdor = odorsRearranged
    if idxPlot == 15
        p(2,idxPlot).select();
        plotSpikeRaster(shank(idxShank2).cell(idxUnit2).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        ylabel(listOdors(idxPlot))
        set(gca, 'XTick' , rasterTicks);
        set(gca, 'XTickLabel', labels);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    else
        p(2,idxPlot).select();
        plotSpikeRaster(shank(idxShank2).cell(idxUnit2).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        set(gca, 'XTick' , []);
        set(gca, 'XTickLabel', []);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        ylabel(listOdors(idxPlot))
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    end
    idxPlot = idxPlot+1;
end

p(2).title(titolo2);



%p.de.margin = 1;
p.margin = [8 6 4 6];
%p(1).marginright = 10;
p(2).marginleft = 30;
%p(3).marginleft = 10;
p.select('all');


set(gcf,'color','white', 'PaperPositionMode', 'auto');

%%
% And cross-correlations for each breath cycle


idxShank1 = 3;
idxUnit1 = 3;
idxShank2 = 4;
idxUnit2 = 3;


figure;
set(gcf,'Position',[27 48 1382 754]);
set(gcf,'Color','w')

idxPlot = 1;
for idxOdor = odorsRearranged
    for idxCycle =1:4
        st1_app = shank(idxShank1).cell(idxUnit1).odor(idxOdor).alphaTrial;
        st2_app = shank(idxShank2).cell(idxUnit2).odor(idxOdor).alphaTrial;
        st1Rsp = 0;
        st2Rsp = 0;
        bslCC = [];
        rspCC = [];
        for idxTrial = 1:n_trials  
            app = [];
            app = st1_app{idxTrial};
            st1Rsp = app(app > (idxCycle-1) * 2 * pi & app < idxCycle * 2 * pi);       
            app = [];
            app = st2_app{idxTrial};
            st2Rsp = app(app > (idxCycle-1) * 2 * pi & app < idxCycle * 2 * pi);
            M1=[]; M2=[]; D=[];
            M1 = length(st1Rsp);
            M2 = length(st2Rsp);
            D = ones(M2,1)*st1Rsp - st2Rsp'*ones(1,M1);
            D = D(:);
            D = radtodeg(D);
            edges = [];
            Nrsp = [];
            [Nrsp edges] = histcounts(D,-360:5:360);
            rspCC(idxTrial,:) = Nrsp;     
        end
        rspCC = mean(rspCC);
        edges(end) = [];  
        h = subplot(15,4,idxPlot);
        area(edges, rspCC); axis tight
        set(h,'FontName','Arial','Fontsize',8,'FontWeight','normal','TickDir','out','Box','off');
        idxPlot = idxPlot + 1;
        drawnow
    end
end

figure;
set(gcf,'Position',[27 48 1382 754]);
set(gcf,'Color','w')
idxPlot = 1;
for idxOdor = odorsRearranged
    for idxCycle =1:4
        st1_app = [];
        st2_app = [];
        st1_bsl = [];
        st1_bsl= [];
        st1_app= mean(shank(idxShank1).cell(idxUnit1).odor(idxOdor).sdf_trialHz(:,(idxCycle+3) * cycleLengthDeg + 1 : (idxCycle+4) * cycleLengthDeg));
        st2_app = mean(shank(idxShank2).cell(idxUnit2).odor(idxOdor).sdf_trialHz(:,(idxCycle+3) * cycleLengthDeg + 1: (idxCycle+4) * cycleLengthDeg));
        st1_bsl = mean(shank(idxShank1).cell(idxUnit1).cycleBslMultipleSdfHz);
        st2_bsl = mean(shank(idxShank2).cell(idxUnit2).cycleBslMultipleSdfHz);
        st1_app = st1_app - st1_bsl;
        st2_app = st2_app - st2_bsl;
        subplot(15,4,idxPlot)
        plot(st1_app, 'linewidth', 2); hold on; plot(st2_app, 'linewidth', 2); hold off; axis tight; 
        set(gca,'FontName','Arial','Fontsize',8,'FontWeight','normal','TickDir','out','Box','off');
        idxPlot = idxPlot + 1;
    end
end

%%
% Let's see what happen between the first unit from the first plot and
% unit 3 on shank3.

idxShank1 = 3;
idxUnit1 = 3;
idxShank2 = 1;
idxUnit2 = 5;

bslWindow = preInhalations * cycleLengthDeg;
odorWindow = 0:postInhalations;
rasterTicks = [-preInhalations :0.5: postInhalations] * 2 * pi; rasterTicks(end) = [];
psthTicks = [0.5 : 2 * (preInhalations + postInhalations) + 0.5]; psthTicks(end) = [];
sdfTicks = [0 : 180 : (preInhalations + postInhalations) * cycleLengthDeg]; %sdfTicks(end) = [];
ciclo = {'i', 'e'}; labels = repmat(ciclo, 1, preInhalations); labels{2 * preInhalations + 1} = '0'; labels{2 * preInhalations + 2} = 'e';
labelsPost = repmat(ciclo, 1, postInhalations - 1); labels = [labels labelsPost];
radTick = [1 cycleLengthDeg];
radLabels={'0','2\pi'};
useColorOnset = 'ForestGreen';

odor_list = {'tmt3', 'dmt3', 'mmt3', 'iba3', 'iaa3',...
             'hed3', 'but3', 'tmt1', 'dmt1', 'mmt1',...
             'iba1', 'iaa1', 'hed1', 'btd1', 'rose'};


listOdors = {'TMT^-4', 'TMT^-2', 'DMT^-4', 'DMT^-2', 'MT^-4', 'MT^-2',...
             'IBA^-4', 'IBA^-2', 'IAA^-4', 'IAA^-2', 'HXD^-4', 'HXD^-2', 'BTD^-4', 'BTD^-2', 'rose'};
odorsRearranged = [1, 8, 2, 9, 3, 10, 4, 11, 5, 12, 6, 13, 7, 14, 15];

binSizes = 5:5:cycleLengthDeg;
timePoints = 5:5:cycleLengthDeg;

titolo1 = sprintf('shank %d, unit %d', idxShank1, idxUnit1);
titolo2 = sprintf('shank %d, unit %d', idxShank2, idxUnit2);



Xfig = 900;
Yfig = 800;
figure;
p = panel();
set(gcf, 'Position',[1,5,Xfig,Yfig]);

p.pack('h',{50 50});

p(1).pack('v', {1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15});
p(2).pack('v', {1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15 ...
    1/15 1/15 1/15 1/15 1/15});


%Find max peak for sdf plot
maxPeak = 0.1;
for idxOdor = odorsRearranged
    maxPeakOdor = max(shank(idxShank2).cell(idxUnit2).odor(idxOdor).cyclePeakResponseAnalogicHz);
    if maxPeakOdor >= maxPeak
        maxPeak = maxPeakOdor;
    end
end
    

% Raster plots
idxPlot = 1;
for idxOdor = odorsRearranged
    if idxPlot == 15
        p(1,idxPlot).select();
        plotSpikeRaster(shank(idxShank1).cell(idxUnit1).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        ylabel(listOdors(idxPlot))
        set(gca, 'XTick' , rasterTicks);
        set(gca, 'XTickLabel', labels);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    else
        p(1,idxPlot).select();
        plotSpikeRaster(shank(idxShank1).cell(idxUnit1).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        set(gca, 'XTick' , []);
        set(gca, 'XTickLabel', []);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        ylabel(listOdors(idxPlot))
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    end
    idxPlot = idxPlot+1;
end

p(1).title(titolo1);

idxPlot = 1;
for idxOdor = odorsRearranged
    if idxPlot == 15
        p(2,idxPlot).select();
        plotSpikeRaster(shank(idxShank2).cell(idxUnit2).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        ylabel(listOdors(idxPlot))
        set(gca, 'XTick' , rasterTicks);
        set(gca, 'XTickLabel', labels);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    else
        p(2,idxPlot).select();
        plotSpikeRaster(shank(idxShank2).cell(idxUnit2).odor(idxOdor).alphaTrial,'PlotType','vertline', 'VertSpikeHeight', 1,'XLimForCell',...
            [-preInhalations postInhalations] * 2 * pi);
        line([0 0], [0 6], 'Color', rgb(useColorOnset))
        %ShadePlotForEmpahsis(odorWindow,'r',0.5);
        set(gca, 'XTick' , []);
        set(gca, 'XTickLabel', []);
        set(gca,'YTick',[])
        %set(gca,'YColor','w')
        ylabel(listOdors(idxPlot))
        set(gca,'FontName','Arial','Fontsize',11,'FontWeight','normal','TickDir','out','Box','off');
    end
    idxPlot = idxPlot+1;
end

p(2).title(titolo2);



%p.de.margin = 1;
p.margin = [8 6 4 6];
%p(1).marginright = 10;
p(2).marginleft = 30;
%p(3).marginleft = 10;
p.select('all');


set(gcf,'color','white', 'PaperPositionMode', 'auto');

%%
% And cross-correlations for each breath cycle


idxShank1 = 3;
idxUnit1 = 3;
idxShank2 = 1;
idxUnit2 = 5;


figure;
set(gcf,'Position',[27 48 1382 754]);
set(gcf,'Color','w')

idxPlot = 1;
for idxOdor = odorsRearranged
    for idxCycle =1:4
        st1_app = shank(idxShank1).cell(idxUnit1).odor(idxOdor).alphaTrial;
        st2_app = shank(idxShank2).cell(idxUnit2).odor(idxOdor).alphaTrial;
        st1Rsp = 0;
        st2Rsp = 0;
        bslCC = [];
        rspCC = [];
        for idxTrial = 1:n_trials  
            app = [];
            app = st1_app{idxTrial};
            st1Rsp = app(app > (idxCycle-1) * 2 * pi & app < idxCycle * 2 * pi);       
            app = [];
            app = st2_app{idxTrial};
            st2Rsp = app(app > (idxCycle-1) * 2 * pi & app < idxCycle * 2 * pi);
            M1=[]; M2=[]; D=[];
            M1 = length(st1Rsp);
            M2 = length(st2Rsp);
            D = ones(M2,1)*st1Rsp - st2Rsp'*ones(1,M1);
            D = D(:);
            D = radtodeg(D);
            edges = [];
            Nrsp = [];
            [Nrsp edges] = histcounts(D,-360:5:360);
            rspCC(idxTrial,:) = Nrsp;     
        end
        rspCC = mean(rspCC);
        edges(end) = [];  
        h = subplot(15,4,idxPlot);
        area(edges, rspCC); axis tight
        set(h,'FontName','Arial','Fontsize',8,'FontWeight','normal','TickDir','out','Box','off');
        idxPlot = idxPlot + 1;
        drawnow
    end
end

figure;
set(gcf,'Position',[27 48 1382 754]);
set(gcf,'Color','w')
idxPlot = 1;
for idxOdor = odorsRearranged
    for idxCycle =1:4
        st1_app = [];
        st2_app = [];
        st1_bsl = [];
        st1_bsl= [];
        st1_app= mean(shank(idxShank1).cell(idxUnit1).odor(idxOdor).sdf_trialHz(:,(idxCycle+3) * cycleLengthDeg + 1 : (idxCycle+4) * cycleLengthDeg));
        st2_app = mean(shank(idxShank2).cell(idxUnit2).odor(idxOdor).sdf_trialHz(:,(idxCycle+3) * cycleLengthDeg + 1: (idxCycle+4) * cycleLengthDeg));
        st1_bsl = mean(shank(idxShank1).cell(idxUnit1).cycleBslMultipleSdfHz);
        st2_bsl = mean(shank(idxShank2).cell(idxUnit2).cycleBslMultipleSdfHz);
        st1_app = st1_app - st1_bsl;
        st2_app = st2_app - st2_bsl;
        subplot(15,4,idxPlot)
        plot(st1_app, 'linewidth', 2); hold on; plot(st2_app, 'linewidth', 2); hold off; axis tight; 
        set(gca,'FontName','Arial','Fontsize',8,'FontWeight','normal','TickDir','out','Box','off');
        idxPlot = idxPlot + 1;
    end
end



##### SOURCE END #####
--></body></html>