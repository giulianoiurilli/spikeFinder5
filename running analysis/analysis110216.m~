[responsivityCoa, auROCCoa, nCellsExpCoa] = findResponsivityAndAurocPerShank(coaCS.esp);
[responsivityPcx, auROCPcx, nCellsExpPcx] = findResponsivityAndAurocPerShank(pcxCS.esp);

%%
fractionPerConcentrationCoa = [];
for idxOdor = 1:3
    for idxShank = 1:4
        app = squeeze(responsivityCoa{idxShank}(:,:,idxOdor));
        for idxExp = 1:size(nCellsExpCoa,1)
            app1 = app(1:nCellsExpCoa(idxExp,idxShank),:);
            app(1:nCellsExpCoa(idxExp,idxShank),:) = [];
            fractionPerConcentrationCoa(idxShank,:,idxOdor, idxExp) = sum(app1)./size(app1,1);
        end
    end
end

fractionPerConcentrationPcx = [];
for idxOdor = 1:3
    for idxShank = 1:4
        app = squeeze(responsivityPcx{idxShank}(:,:,idxOdor));
        for idxExp = 1:size(nCellsExpPcx,1)
            app1 = app(1:nCellsExpPcx(idxExp,idxShank),:);
            app(1:nCellsExpPcx(idxExp,idxShank),:) = [];
            fractionPerConcentrationPcx(idxShank,:,idxOdor, idxExp) = sum(app1)./size(app1,1);
        end
    end
end
 %%   
 figure
 set(gcf,'Position',[207 90 395 642]);
 set(gcf,'color','white', 'PaperPositionMode', 'auto');
 
 colors = [228,26,28;...
55,126,184;...
77,175,74] ./ 255;
 
 for idxConc = 1:5
     subplot(5,1,idxConc)
     means = [];
     sems = [];
     for idxOdor = 1:3
         app = (squeeze(fractionPerConcentrationCoa(:,idxConc,idxOdor,:)))';
         app(isnan(app)) = 0;
         media = mean(app);
         errore = std(app) ./ sqrt(size(fractionPerConcentrationCoa,4) - 1);
         means(:,idxOdor) = media';
         sems(:,idxOdor) = errore';
     end
     b = barwitherr(sems, means);
     ylim([0 0.3])
     b(1).EdgeColor = colors(1,:);
     b(2).EdgeColor = colors(2,:);
     b(3).EdgeColor = colors(3,:);
     b(1).FaceColor = colors(1,:);
     b(2).FaceColor = colors(2,:);
     b(3).FaceColor = colors(3,:);
     set(gca, 'tickDir', 'out', 'fontname', 'arial', 'fontsize', 14)
 end
 %%   
 figure
 set(gcf,'Position',[207 90 395 642]);
 set(gcf,'color','white', 'PaperPositionMode', 'auto');
 for idxConc = 1:5
     subplot(5,1,idxConc)
     for idxOdor = 1:3
         app = (squeeze(fractionPerConcentrationPcx(:,idxConc,idxOdor,:)))';
         app(isnan(app)) = 0;
         app(app>1) = 0;
         media = nanmean(app);
         errore = std(app) ./ sqrt(size(fractionPerConcentrationPcx,4) - 1);
         means(:,idxOdor) = media';
         sems(:,idxOdor) = errore';
     end
     b = barwitherr(sems, means);
     ylim([0 0.3])
     b(1).EdgeColor = colors(1,:);
     b(2).EdgeColor = colors(2,:);
     b(3).EdgeColor = colors(3,:);
     b(1).FaceColor = colors(1,:);
     b(2).FaceColor = colors(2,:);
     b(3).FaceColor = colors(3,:);
     set(gca, 'tickDir', 'out', 'fontname', 'arial', 'fontsize', 14)
 end
 
 
 %%
 for idxShank = 1:4
     for idxConc = 1:5
         app1 = squeeze(responsivityCoa{idxShank}(:,idxConc,:));
         app2 = squeeze(auROCCoa{idxShank}(:,idxConc,:));
         app3 = [];
         for idxCell = 1:size(app1,1)
             if sum(app1(idxCell,:)) > 0
                 app3 = [app3; app2(idxCell,:)];
             end
         end
         meanAuRocCoa(idxConc,:,idxShank) = mean(app3);
         semAuRocCoa(idxConc,:,idxShank) = std(app3)/sqrt(size(app3,1)-1);
     end
 end
 
 figure
 set(gcf,'Position',[207 90 395 642]);
 set(gcf,'color','white', 'PaperPositionMode', 'auto');
  for idxConc = 1:5
     subplot(5,1,idxConc)
%      for idxOdor = 1:3
%          plot(squeeze(meanAuRocCoa(idxConc,idxOdor,:)))
%          hold on
%      end
          b = barwitherr(squeeze(semAuRocCoa(idxConc,:,:))', squeeze(meanAuRocCoa(idxConc,:,:))');
     b(1).EdgeColor = colors(1,:);
     b(2).EdgeColor = colors(2,:);
     b(3).EdgeColor = colors(3,:);
     b(1).FaceColor = colors(1,:);
     b(2).FaceColor = colors(2,:);
     b(3).FaceColor = colors(3,:);
     ylim([0.5 1])
     set(gca, 'tickDir', 'out', 'fontname', 'arial', 'fontsize', 14)
  end
 
   %%
 for idxShank = 1:4
     for idxConc = 1:5
         app1 = squeeze(responsivityPcx{idxShank}(:,idxConc,:));
         app2 = squeeze(auROCPcx{idxShank}(:,idxConc,:));
         app3 = [];
         for idxCell = 1:size(app1,1)
             if sum(app1(idxCell,:)) > 0
                 app3 = [app3; app2(idxCell,:)];
             end
         end
         meanAuRocPcx(idxConc,:,idxShank) = mean(app3);
         semAuRocPcx(idxConc,:,idxShank) = std(app3)/sqrt(size(app3,1)-1);
     end
 end
 
 figure
 set(gcf,'Position',[207 90 395 642]);
 set(gcf,'color','white', 'PaperPositionMode', 'auto');
  for idxConc = 1:5
     subplot(5,1,idxConc)
%      for idxOdor = 1:3
%          plot(squeeze(meanAuRocPcx(idxConc,idxOdor,:)))
%          hold on
%      end
          b = barwitherr(squeeze(semAuRocPcx(idxConc,:,:))', squeeze(meanAuRocPcx(idxConc,:,:))');
     b(1).EdgeColor = colors(1,:);
     b(2).EdgeColor = colors(2,:);
     b(3).EdgeColor = colors(3,:);
     b(1).FaceColor = colors(1,:);
     b(2).FaceColor = colors(2,:);
     b(3).FaceColor = colors(3,:);
     ylim([0.5 1])
     set(gca, 'tickDir', 'out', 'fontname', 'arial', 'fontsize', 14)
  end
 
%%
[sigAnovaCoa] = concSeriesAnalysis2_new(coaCS.esp, 1:15);
[sigAnovaPcx] = concSeriesAnalysis2_new(pcxCS.esp, 1:15);




%%
[VariantCoa, InvariantCoa, nonmonotonicCoa, nonmonotonicSemCoa, monotonicDCoa, monotonicDSemCoa, monotonicICoa, monotonicISemCoa] = findConcInvarianceAndMonotonicity_new(coaCS.esp);
[VariantPcx, InvariantPcx, nonmonotonicPcx, nonmonotonicSemPcx, monotonicDPcx, monotonicDSemPcx, monotonicIPcx, monotonicISemPcx] = findConcInvarianceAndMonotonicity_new(pcxCS.esp);
figure
set(gcf,'color','white', 'PaperPositionMode', 'auto');
for idxOdor = 1:3
xMean = [VariantCoa(idxOdor) VariantPcx(idxOdor); InvariantCoa(idxOdor) InvariantPcx(idxOdor)];
semCoa = sqrt(xMean(1,1) * xMean(2,1) / (numel(sigAnovaCoa)-1));
semPcx = sqrt(xMean(1,2) * xMean(2,2) / (numel(sigAnovaPcx)-1));
xSem = [semCoa, semPcx; semCoa, semPcx];


subplot(3,1,idxOdor)
b = barwitherr(xSem, xMean);
b(1).EdgeColor = coaC;
b(1).FaceColor = coaC;
b(2).EdgeColor = pcxC;
b(2).FaceColor = pcxC;
set(gca, 'box', 'off', 'tickDir', 'out', 'fontname', 'arial', 'fontsize', 14)
end


figure
set(gcf,'color','white', 'PaperPositionMode', 'auto');
for idxOdor = 1:3
    xMean = [nonmonotonicCoa(idxOdor) nonmonotonicPcx(idxOdor); monotonicDCoa(idxOdor) monotonicDPcx(idxOdor); monotonicICoa(idxOdor) monotonicIPcx(idxOdor)];
    xSem = [nonmonotonicSemCoa(idxOdor) nonmonotonicSemPcx(idxOdor); monotonicDSemCoa(idxOdor) monotonicDSemPcx(idxOdor); monotonicISemCoa(idxOdor) monotonicISemPcx(idxOdor)];

end
%%
[concCoa, totalResponsiveSUACoa] = findOdorDiscriminative_new(coaCS.esp, odors);
[concPcx, totalResponsiveSUAPcx] = findOdorDiscriminative_new(pcxCS.esp, odors);
figure
set(gcf,'color','white', 'PaperPositionMode', 'auto');
concCoaP = concCoa ./ totalResponsiveSUACoa;
concPcxP = concPcx ./ totalResponsiveSUAPcx;
p_1 = ones(1,5);
p_1Coa = p_1 - concCoaP;
p_1Pcx = p_1 - concPcxP;

for idxConc = 1:5
    semCoa(idxConc) = sqrt(concCoaP(idxConc) * p_1Coa(idxConc) ./  (totalResponsiveSUACoa-1));
    semPcx(idxConc) = sqrt(concPcxP(idxConc) * p_1Pcx(idxConc) ./  (totalResponsiveSUAPcx-1));
end

meanX = [concCoaP', concPcxP'];
semX = [semCoa' semPcx'];

b = barwitherr(semX, meanX);
b(1).EdgeColor = coaC;
b(1).FaceColor = coaC;
b(2).EdgeColor = pcxC;
b(2).FaceColor = pcxC;
set(gca, 'box', 'off', 'tickDir', 'out', 'fontname', 'arial', 'fontsize', 14)



%%






nonResponsiveCoa = numel(find(sigAnovaCoa==0)) ./ numel(sigAnovaCoa);
odorIDCoa = numel(find(sigAnovaCoa==1)) ./ numel(sigAnovaCoa);
odorConcCoa = numel(find(sigAnovaCoa==2)) ./ numel(sigAnovaCoa);
odorBothCoa = numel(find(sigAnovaCoa==3)) ./ numel(sigAnovaCoa);

nonResponsivePcx = numel(find(sigAnovaPcx==0)) ./ numel(sigAnovaPcx);
odorIDPcx = numel(find(sigAnovaPcx==1)) ./ numel(sigAnovaPcx);
odorConcPcx = numel(find(sigAnovaPcx==2)) ./ numel(sigAnovaPcx);
odorBothPcx = numel(find(sigAnovaPcx==3)) ./ numel(sigAnovaPcx);


semNRCoa = sqrt(nonResponsiveCoa * (1-nonResponsiveCoa)/(numel(sigAnovaCoa)-1));
semNRPcx = sqrt(nonResponsivePcx * (1-nonResponsivePcx)/(numel(sigAnovaCoa)-1));
semIDCoa = sqrt(odorIDCoa * (1-odorIDCoa)/(numel(sigAnovaCoa)-1));
semIDPcx = sqrt(odorIDPcx * (1-odorIDPcx)/(numel(sigAnovaCoa)-1));
semCOCoa = sqrt(odorConcCoa * (1-odorConcCoa)/(numel(sigAnovaCoa)-1));
semCOPcx = sqrt(odorConcPcx * (1-odorConcPcx)/(numel(sigAnovaCoa)-1));
semBOCoa = sqrt(odorBothCoa * (1-odorBothCoa)/(numel(sigAnovaCoa)-1));
semBOPcx = sqrt(odorBothPcx * (1-odorBothPcx)/(numel(sigAnovaCoa)-1));
%%

xMean = [odorIDCoa, odorIDPcx;...
    odorConcCoa, odorIDPcx;...
    odorBothPcx, odorBothPcx];

xSem = [semIDCoa, semIDPcx;...
    semCOCoa, semCOPcx;...
    semBOCoa, semBOPcx];


figure
b = barwitherr(xSem, xMean);
b(1).EdgeColor = coaC;
b(1).FaceColor = coaC;
b(2).EdgeColor = pcxC;
b(2).FaceColor = pcxC;

set(gcf,'color','white', 'PaperPositionMode', 'auto');
set(gca, 'box', 'off', 'tickDir', 'out', 'fontname', 'arial', 'fontsize', 14)


